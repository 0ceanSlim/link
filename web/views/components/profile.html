{{define "profile"}}
<div class="flex flex-col items-center mb-6">
  <img
    src="{{.Picture}}"
    alt="Profile Picture"
    class="object-cover w-64 h-64 mb-4 border-4 shadow-lg rounded-xl border-bgInverted"
  />
  <h2 class="text-2xl font-bold text-center">{{.DisplayName}}</h2>
</div>

<p class="mb-4 text-sm text-center text-textMuted">{{.PublicKey}}</p>

<div class="w-full max-w-2xl p-6 rounded-lg bg-bgPrimary">
  <p class="text-lg text-left">{{.About}}</p>
</div>

<!-- Donation Addresses -->
<div class="w-full max-w-2xl p-6 mt-6 rounded-lg bg-bgPrimary">
  <h3 class="mb-4 text-xl font-semibold text-center">
    Your Donation Addresses
  </h3>
  <ul id="donation-list" class="space-y-2 text-left">
    {{if .DonationTags}} {{range .DonationTags}}
    <li
      class="flex items-center justify-between p-3 rounded-lg shadow bg-bgSecondary"
    >
      <div>
        <strong class="text-lg">{{index . 1}}</strong>:
        <span class="text-sm break-all">{{index . 2}}</span>
        {{if (gt (len .) 3)}} ({{index . 3}}) {{end}}
      </div>
      <button
        onclick="removeDonationAddress('{{index . 1}}', '{{index . 2}}', '{{if (gt (len .) 3)}}{{index . 3}}{{end}}')"
      >
        Remove
      </button>
    </li>
    {{end}} {{else}}
    <p class="text-sm text-center text-textMuted">
      No donation addresses set yet.
    </p>
    {{end}}
  </ul>
</div>

<!-- Add Donation Address Form -->
<div class="w-full max-w-2xl p-6 mt-6 rounded-lg bg-bgPrimary">
  <h3 class="mb-4 text-xl font-semibold text-center">
    Add New Donation Address
  </h3>
  <form id="donation-form">
    <div id="donation-fields" class="space-y-3 text-black">
      <div
        class="flex flex-col gap-2 p-4 rounded-lg shadow donation-group bg-bgSecondary"
      >
        <input
          type="text"
          name="ticker_0"
          placeholder="Asset Ticker (e.g., BTC)"
          class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent"
          required
        />
        <input
          type="text"
          name="network_0"
          placeholder="Network (e.g., Bitcoin)"
          class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent"
          required
        />
        <input
          type="text"
          name="address_0"
          placeholder="Receiving Address"
          class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent"
          required
        />
      </div>
    </div>

    <div class="flex flex-col gap-2 mt-4 sm:flex-row">
      <button type="button" onclick="addField()">+ Add More</button>
      <button type="submit">Save</button>
    </div>
  </form>
</div>

<script>
  async function removeDonationAddress(asset, address, network = "") {
    if (!window.nostr) {
      alert("Nostr extension not available.");
      return;
    }

    try {
      const pubkey = await window.nostr.getPublicKey();
      const relay = "wss://wheat.happytavern.co";
      const profileEvent = await fetchLatestProfile(pubkey, relay);

      if (!profileEvent) {
        alert("Failed to fetch profile event.");
        return;
      }

      // **Remove the selected `w` tag**
      let updatedTags = profileEvent.tags.filter((tag) => {
        return !(
          tag[0] === "w" &&
          tag[1] === asset &&
          tag[2] === address &&
          (tag.length === 3 || tag[3] === network)
        );
      });

      console.log("‚úÖ Updated tags after removal:", updatedTags);

      // **Create and sign the updated kind 0 profile event**
      const updatedEvent = {
        kind: 0,
        created_at: Math.floor(Date.now() / 1000),
        tags: updatedTags,
        content: profileEvent.content || "",
      };

      console.log("üìù Signing event...");
      const signedEvent = await window.nostr.signEvent(updatedEvent);
      console.log("‚úÖ Signed Event:", signedEvent);

      // **Send the updated event**
      const response = await fetch("/save_donation_addresses", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(signedEvent),
      });

      if (!response.ok) {
        throw new Error(`Failed to update profile: ${await response.text()}`);
      }

      console.log("‚úÖ Profile updated successfully!");

      // **Fetch updated profile before reloading**
      await fetchUpdatedProfile();

      alert("Donation address removed successfully!");

      setTimeout(() => {
        window.location.reload();
      }, 500); // ‚úÖ Small delay before refreshing
    } catch (error) {
      console.error("‚ùå Error updating profile:", error);
      alert(`Error: ${error.message}`);
    }
  }
</script>

<script>
  let count = 1;

  function addField() {
    const container = document.getElementById("donation-fields");
    const div = document.createElement("div");
    div.className =
      "donation-group flex flex-col gap-2 p-4 bg-bgSecondary rounded-lg shadow";
    div.innerHTML = `
      <input type="text" name="ticker_${count}" placeholder="Asset Ticker (e.g., BTC)" class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent" required>
      <input type="text" name="network_${count}" placeholder="Network (e.g., Bitcoin)" class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent" required>
      <input type="text" name="address_${count}" placeholder="Receiving Address" class="p-2 border rounded border-bgInverted focus:ring focus:ring-accent" required>
      <button type="button" onclick="removeField(this)" class="px-4 py-1 mt-2 text-sm font-semibold text-white bg-red-500 rounded-lg shadow hover:bg-red-600">Remove</button>
    `;
    container.appendChild(div);
    count++;
  }

  function removeField(button) {
    button.parentElement.remove();
  }
</script>
<script>
  document
    .getElementById("donation-form")
    .addEventListener("submit", async (event) => {
      event.preventDefault();

      const formData = new FormData(event.target);
      let newDonationTags = [];

      for (let i = 0; formData.has(`ticker_${i}`); i++) {
        const ticker = formData.get(`ticker_${i}`).trim();
        const network = formData.get(`network_${i}`).trim();
        const address = formData.get(`address_${i}`).trim();

        if (ticker && address) {
          if (network) {
            newDonationTags.push(["w", ticker, address, network]); // ‚úÖ New format
          } else {
            newDonationTags.push(["w", ticker, address]); // ‚úÖ Without network
          }
        }
      }

      if (newDonationTags.length === 0) {
        alert("Please enter at least one donation address.");
        return;
      }

      if (!window.nostr) {
        alert("Nostr extension not found! Install a Nostr extension.");
        return;
      }

      try {
        const pubkey = await window.nostr.getPublicKey();
        const relay = "wss://wheat.happytavern.co";
        const profileEvent = await fetchLatestProfile(pubkey, relay);

        if (!profileEvent || !profileEvent.tags) {
          alert("Failed to fetch existing donation addresses.");
          return;
        }

        let updatedTags = [...profileEvent.tags];

        let existingDonationTags = updatedTags.filter((tag) => tag[0] === "w");

        newDonationTags.forEach((newTag) => {
          if (
            !existingDonationTags.some(
              (existingTag) =>
                JSON.stringify(existingTag) === JSON.stringify(newTag)
            )
          ) {
            existingDonationTags.push(newTag);
          }
        });

        updatedTags = updatedTags.filter((tag) => tag[0] !== "w"); // ‚úÖ Remove old "w" tags
        updatedTags.push(...existingDonationTags); // ‚úÖ Append all "w" tags back

        const updatedEvent = {
          kind: 0,
          created_at: Math.floor(Date.now() / 1000),
          tags: updatedTags,
          content: profileEvent.content || "",
        };

        const signedEvent = await window.nostr.signEvent(updatedEvent);

        const response = await fetch("/save_donation_addresses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(signedEvent),
        });

        if (!response.ok) {
          throw new Error(`Failed to save addresses: ${await response.text()}`);
        }

        alert("Donation address added successfully!");

        // **Fetch updated profile immediately before refreshing**
        await fetchUpdatedProfile();

        setTimeout(() => {
          window.location.reload();
        }, 500);
      } catch (error) {
        console.error("‚ùå Error updating donation addresses:", error);
        alert(`Error: ${error.message}`);
      }
    });

  // Fetch the updated profile metadata and update the UI
  async function fetchUpdatedProfile() {
    try {
      const response = await fetch("/fetch_user_metadata");
      if (!response.ok) throw new Error("Failed to fetch updated profile");

      const data = await response.json();
      console.log("üõ†Ô∏è Updated Profile Data:", data);

      const donationList = document.getElementById("donation-list");
      donationList.innerHTML = "";

      if (data.tags.length > 0) {
        data.tags.forEach((tag) => {
          if (tag[0] === "w") {
            console.log("‚úÖ Found donation tag:", tag);
            const li = document.createElement("li");
            li.className = "p-3 rounded-lg bg-bgSecondary shadow";
            li.innerHTML = `<strong>${tag[1]}</strong>: <span>${
              tag[2]
            }</span> ${tag.length > 3 ? `(${tag[3]})` : ""}`;
            donationList.appendChild(li);
          }
        });
      } else {
        donationList.innerHTML =
          '<p class="text-sm text-center text-textMuted">No donation addresses set yet.</p>';
      }
    } catch (error) {
      console.error("‚ùå Failed to refresh profile:", error);
    }
  }

  // Fetch the user's latest kind: 0 profile event
  async function fetchLatestProfile(pubkey, relay) {
    return new Promise((resolve, reject) => {
      const ws = new WebSocket(relay);

      ws.onopen = () => {
        const filter = {
          kinds: [0], // Kind 0 = Profile Metadata
          authors: [pubkey], // Get only the user's profile
          limit: 1, // Only fetch the latest event
        };
        ws.send(JSON.stringify(["REQ", "profile-req", filter]));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data[0] === "EVENT") {
          console.log("‚úÖ Received profile event from relay:", data);

          const profileEvent = data[2];

          // **Debug Log: Check if we're getting all the `w` tags**
          console.log("üîç Raw Profile Tags from Relay:", profileEvent.tags);

          ws.close();
          resolve(profileEvent);
        }
      };

      ws.onerror = (err) => {
        console.error("‚ùå WebSocket error:", err);
        ws.close();
        reject("Failed to fetch profile.");
      };

      setTimeout(() => {
        ws.close();
        reject("Timeout fetching profile.");
      }, 5000);
    });
  }
</script>

{{end}}
